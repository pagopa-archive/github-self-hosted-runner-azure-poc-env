name: Release

on:
  # Trigger the workflow on push on the main branch
  push:
    branches:
      - main
    paths-ignore:
      - 'CODEOWNERS'
      - '**.md'
      # - '.**'

permissions:
      id-token: write
      contents: read

jobs:
  setup_runner:
    name: Setup Runner
    runs-on: ubuntu-22.04

    steps:
      # - name: Checkout
      #   id: checkout
      #   uses: actions/checkout@v2
      #   with:
      #     persist-credentials: false
      #     fetch-depth: 0
      
      - name: Login
        id: login
        uses: azure/login@v1
        with:
          # ENVIRONMENT: prod
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # - name: 'Run Azure CLI commands'
      #   run: |
      #     az account show
      #     az group list
      #     pwd

      - name: Create GitHub Runner
        id: create_github_runner
        run: |
          GITHUB_REPO=${{ github.repository }}
          GITHUB_REPO=${GITHUB_REPO////-}
          echo $GITHUB_REPO
          GITHUB_TOKEN=$(curl \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.BOT_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token | jq ".token" -r)
            
          az config set extension.use_dynamic_install=yes_without_prompt

          az containerapp create -n ${GITHUB_REPO}-${{ github.run_id }} -g pasquale-test \
            --image ghcr.io/pagopa/github-self-hosted-runner:v1.0.3 \
            --environment capp-env-pasq \
            --secrets github-token="${GITHUB_TOKEN}" \
            --env-vars \
            GITHUB_REPOSITORY="https://github.com/${{ github.repository }}" \
            SECRETENV=github-token

      # - name: Create GitHub Runner
      #   id: create_github_runner
      #   run: |
      #     GITHUB_TOKEN=$(curl \
      #       -X POST \
      #       -H "Accept: application/vnd.github+json" \
      #       -H "Authorization: Bearer ${{ secrets.BOT_TOKEN }}" \
      #       https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token | jq ".token" -r)
            
      #     az config set extension.use_dynamic_install=yes_without_prompt

      #     az containerapp create -n io-infra-pasq-${{ github.run_id }} -g pasquale-test \
      #       --image ghcr.io/pagopa/github-self-hosted-runner:v1.0.3 \
      #       --environment capp-env-pasq \
      #       --secrets github-token="${GITHUB_TOKEN}" \
      #       --env-vars \
      #       GITHUB_REPOSITORY="https://github.com/${{ github.repository }}" \
      #       SECRETENV=github-token